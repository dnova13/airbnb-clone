{% extends "base.html" %}
{% load i18n %}

{% block page_title %}
    Conversation
{% endblock page_title %}

{% block search-bar %}
{% endblock search-bar %}

{% block content %}
     
    <div id={{ conversation.pk }} class="conv container mx-auto my-10 mt-32 flex justify-between min-h-50vh">

        <div class="border w-1/4 p-10 ">
            <span class="text-center w-full block text-lg font-medium">{% trans "Conversation between:" %}</span>
            <div class="flex justify-center mt-10 items-center">
                <div class="flex flex-col items-center">
                    {% include "mixins/user_avatar.html" with user=me %}
                    <span class="mt-2 text-gray-500 truncate" style="max-width:5rem">{{me.first_name}}</span>
                </div>
                <span class="font-medium text-2xl">&</span>
                <a href="{{opponent.get_absolute_url}}">
                    <div class="flex flex-col items-center">
                        {% include "mixins/user_avatar.html" with user=opponent %}
                        <span class="mt-2 text-gray-500 ml truncate" style="max-width:5rem">{{opponent.first_name}}</span>
                    </div>
                </a>
            </div>
        </div>
        <div class="flex-grow">
            <div class="chat-scroll border ml-10 p-10 pb-0 flex flex-col">
                {% if conversation.messages.count == 0 %}
                    {% trans "no messages" %}
                {% else %}
                    {% for message in conversation.messages.all  %}
                        <div class="mb-10 {% if message.user.pk == user.pk %}
                            self-end text-right
                        {% endif %}">
                            <span class="text-sm font-medium  w-56 text-gray-600 truncate">{{message.user.first_name | slice:12}}{% if last_msg_obj.message|length > 12 %}...{% endif %}</span>
                            <div class="mt-px p-5 w-56 rounded break-words text-left
                                {% if message.user.pk == user.pk %}
                                    bg-teal-500
                                    text-white
                                {% else %}
                                    bg-gray-300
                                {% endif %}
                            ">
                                {{message.message}}
                            </div>
                            <p class="text-xs">{{message.created}}</p>
                            {% if message.user.pk == user.pk  %}
                                {% if message.is_read == False %}
                                    <p class="text-xs">1</p>
                                {% endif %}
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endif %}
                
            </div>
            <form class="mt-10 w-1/2 mx-auto" method="POST">
                {% csrf_token %}
                <input class="border-box mb-5" name="message" placeholder="Write a Message" required />
                <button class="btn-link">Send Comment</button>
            </form>
        </div>

    </div>
    <script>
        let objDiv = document.querySelector(".chat-scroll"); 
        objDiv.scrollTop = objDiv.scrollHeight;
    </script>
    <script type="text/javascript">

        let _pk = document.querySelector(".conv").id
        let chatSocket = new WebSocket(
            `ws://${window.location.host}/ws/conversation/${_pk}/`
        );

        chatSocket.onmessage = (e) => {
            let data = JSON.parse(e.data);
            console.log(data)
            let message = data['message'];
            console.log("!!!!!!!!!!!!!!!");
            document.querySelector("#chat-log").value += (message + '\n');
        };

        chatSocket.onclose = (e) => {
            console.error('Chat socket closed unexpectedly');
        };

       {% comment %}  document.querySelector("#chat-message-input").focus();
        document.querySelector("#chat-message-input").addEventListener("keyup",(e) => {
            if (e.keyCode === 13) { 
                document.querySelector("#chat-message-submit").click();
            }
        });

        document.querySelector("#chat-message-submit").addEventListener("click", (e) => {
            let messageInputDom = document.querySelector("#chat-message-input");
            let message = messageInputDom.value;
            
            chatSocket.send(JSON.stringify({
                'message' : message,
                "abc" : "DDDD"
            }));

            messageInputDom.value = '';
        }); {% endcomment %}
    </script>
{% endblock content %}