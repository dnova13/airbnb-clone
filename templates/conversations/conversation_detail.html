{% extends "base.html" %}
{% load i18n static %}

{% block page_title %}
    Conversation
{% endblock page_title %}

{% block search-bar %}
{% endblock search-bar %}

{% block content %}
     
    <div id={{ conversation.pk }} class="conv container mx-auto my-10 mt-32 flex justify-between min-h-50vh">

        <div class="border w-1/4 p-10 ">
            <span class="text-center w-full block text-lg font-medium break-words">{% trans "Conversation between:" %}</span>
            <div class="flex justify-center mt-10 items-center">
                <div class="flex flex-col items-center">
                    {% include "mixins/user_avatar.html" with user=me %}
                    <span class="mt-2 text-gray-500 truncate" style="max-width:5rem">{{me.first_name}}</span>
                </div>
                <span class="font-medium text-2xl">&</span>
                <a href="{{opponent.get_absolute_url}}">
                    <div class="flex flex-col items-center">
                        {% include "mixins/user_avatar.html" with user=opponent %}
                        <span class="mt-2 text-gray-500 ml truncate" style="max-width:5rem">{{opponent.first_name}}</span>
                    </div>
                </a>
            </div>
        </div>
        <div class="flex-grow">
            <div class="chat-scroll border ml-10 p-10 pb-0 flex flex-col">
                {% if conversation.messages.count == 0 %}
                    <span class="pb-10">{% trans "no messages" %}</span>
                {% else %}
                    {% for message in conv_messages|dictsort:"id"  %}
                        <div class="conv-msg mb-10 {% if message.user.pk == user.pk %}
                            self-end text-right
                        {% endif %}">
                            <span class="text-sm font-medium  w-56 text-gray-600 truncate">{{message.user.first_name | slice:12}}{% if message.user.first_name|length > 12 %}...{% endif %}</span>
                            <div class="mt-px p-5 w-56 rounded break-words text-left
                                {% if message.user.pk == user.pk %}
                                    bg-teal-500
                                    text-white
                                {% else %}
                                    bg-gray-300
                                {% endif %}
                            ">
                                {{message.message}}
                            </div>
                            {% get_current_language as LANGUAGE_CODE %}
                            <p class="text-xs">
                                {% if LANGUAGE_CODE == "en" %}
                                    {{ message.created|date:"M. j Y, h:i a" }}
                                {% else %}
                                    {{ message.created }}
                                {% endif %}
                            </p>
                            {% if message.user.pk == user.pk  %}
                                {% if message.is_read == False %}
                                    <p class="is-read text-xs">1</p>
                                {% endif %}
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
            <form class="mt-10 w-1/2 mx-auto" method="POST">
                {% csrf_token %}
                <input class="border-box mb-5" name="message" placeholder="Write a Message" required />
                <button id="send_msg" class="btn-link">Send Comment</button>
            </form>
        </div>

    </div>
    <script src="{% url 'javascript-catalog' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.0/moment-with-locales.min.js"></script>
    <script>
        let loc = "{{LANGUAGE_CODE}}"
        
        const _id = {{user.pk}}
        const _id_op = {{opponent.pk}}
        const _name = "{{user.first_name}}"
        
        moment.locale(loc)
    </script>
    <script src="{% static 'js/socket_coversation.js' %}"></script>
    <script src="{% static 'js/ajax_call.js' %}"></script>
    <script src="{% static 'js/socket.js' %}"></script>
    
{% endblock content %}



